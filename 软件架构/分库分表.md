## <center> 分库分表 </center>
当数据量特别大时，单台数据库服务器的存储能力成为了系统的瓶颈时，需要进行分库分表操作。
### 业务分库
业务分库指的是按照业务模块将数据分散到不同的数据库服务器中。
但是分散存储解决存储压力的同时也带来了新的问题：
- **join操作问题**：业务分库之后，原先在同一个库中的数据现在分散在不同库中了，导致无法使用Join查询。

- **事务问题**：原本在统一数据库中的不同表可以在同一事务中进行修改，业务进行分散之后，无法通过事务统一进行修改。

- **成本问题**：一台服务器变成3台，如果考虑进去备份的话则会消耗更多。

针对小公司初创，不建议进行业务分库。

---

### 业务分表
极端情况下，考虑一个表已经占满了整个单机服务器，这样便会达到单机的处理瓶颈，便可以对表进行分表操作，常见的分表操作有**垂直分表**和**水平分表**
<div align=center>
<img src="../img/分表.png">
</div>

- 垂直分表是把一个表按列拆成了多个表；
- 水平分表是把一个表数据行拆成了多个表；

#### 复杂性引入
 1. 垂直分表

垂直分表适合将某些不常用且占了大量空间的列拆分出去，但是表操作的数量会增加，原来一次查询就可以获得的所有信息现在需要两次查询。

2. 水平分表

水平分表适合表行数特别大的表，例如单表行数超过了5000W行，水平分表引入的复杂性比垂直分表要多，具体如下：

- 水平分表之后，哪条数据属于哪个表就需要引入路由算法进行计算，常见的路由算法有：
  - 范围路由：数据属于一个范围的进入一个表；
  - 哈希路由：顾名思义；
  - 配置路由：新建一个路由表进行查询；
- Join操作：水平分表后，数据分散在多个表中，如果需要与其他表进行 join 查询，需要在业务代码或者数据库中间件中进行多次 join 查询，然后将结果合并。
- count()操作：水平分表后，虽然物理上数据分散到多个表中，但某些业务逻辑上还是会将这些表当作一个表来处理。例如，获取记录总数用于分页或者展示，水平分表前用一个 count() 就能完成的操作，在分表后就没那么简单了。常见的处理方式有下面两种：
  - count()相加：具体做法是在业务代码或者数据库中间件中对每个表进行 count() 操作，然后将结果相加。这种方式实现简单，缺点就是性能比较低。例如，水平分表后切分为 20 张表，则要进行 20 次 count(* ) 操作，如果串行的话，可能需要几秒钟才能得到结果。
  - 记录数表：具体做法是新建一张表，假如表名为“记录数表”，包含 table_name、row_count 两个字段，每次插入或者删除子表数据成功后，都更新“记录数表”。
- order by 操作：分散到多个表中无法排序，只能通过业务代码或者中间件完成；

### 思考
1.做硬件优化，例如从机械硬盘改成使用固态硬盘；

2.先做数据库服务器的调优操作，例如增加索引，oracle有很多的参数调整;

3.引入缓存技术，例如Redis，减少数据库压力；

4.程序与数据库表优化，重构，例如根据业务逻辑对程序逻辑做优化，减少不必要的查询;

5.在这些操作都不能大幅度优化性能的情况下，不能满足将来的发展，再考虑分库分表，也要有预估性
