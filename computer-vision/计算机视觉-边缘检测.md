# <center> 边缘检测 </center>
## 边缘的定义
最常用的定义是理想阶梯型边缘(ideal step edge)

在一维的示例中，边缘就是在某个位置发生的灰阶变化，当灰阶变化越大时，边缘检测也越容易。但是
伴随着两个难点。

### １. 数码化
图像的采样不可能使得整个边缘刚好落在像素边界上，事实上灰阶的变化可能遍及一块区域的多个像素，在
一维的示例中就是“斜坡”，在数码化后的图像中，这个斜坡实际上呈现的是阶梯锯齿状。

### 2. 噪声问题
光强度、相机质量、移动、温度、大气效应、粉层等因素会增加图片上的噪声，因此在图片中表示相同灰阶
的像素在现实中是不同的。噪声是一种随机效应，因此只能通过统计的方法特征化。噪声对图像造成的结果是
使得有些像素的灰阶产生随机的变化，因此理想中的平滑线条在图像中是不可能存在的。**通常的做法是通过
噪声对图像造成的效果进行特征化，而噪声的特征可以通过特定平均值(mean)和标准偏差(standard
  deviation)的概率分布表示**。

在图像分析中，我们一般考虑两种类型的噪声：
- 信号无关的噪声(signal-independent noise)：随机的灰阶值，与图像数据无关，例如图像通过电信号进行传输时就会产生这种噪声。通常假设噪声服从均值为0的正态分布。
- 信号相关的噪声(signal-independent noise)：图像中的每一点的噪声值的大小为这一点的灰阶值的函数。一些照片中的颗粒就是这种噪声的例子。

图像的边缘是由灰阶（或者彩色）等高线定义的。穿过等高线的时候，灰阶值会迅速变化；沿着等高线走，会截止的变化会更加轻柔，有可能是随机变化。因此：边缘具有一个可以测量的方向。

边缘像素和噪声像素都具有的特点是：相比周围的像素有明显的灰阶变化。而边缘像素互相连接，构成了等高线，因此可以通过者一个特性将边缘像素和噪声像素区分。

基本上有三种常见的算子可以用于定位边缘：
- 导数算子：这种算子被设计会标识发生巨大强度变化的地方。
- 类似于模板匹配的方案，其中边缘由一个很小的图像进行建模，这个图像表现出了完美边缘的抽象属性。
- 一些算子使用了边缘的数学模型。其中最好的也使用了噪声模型，并且努力把噪声因素也考虑进去。

#### 导数算子
边缘是由灰阶值的变化定义的，因此对这种变化敏感的算子就可以用做边缘检测器。导数算子就可以。（未深入研究）

#### 基于模板的边缘检测
将一个小的离散的模板作为边缘的模型，常用的有Sobel边缘检测器，它具有如下的卷积掩模(convolution mask)作为模板：
$$
\begin{matrix}
-1 & -2 & -1\\
 0&   0&   0\\
 1&  2&    1
\end{matrix} = S_{y} \,\,\,\,\,\,\,\,
\begin{matrix}
-1 & -0 & 1\\
 -2&   0&   2\\
 -1&  0&    1
\end{matrix} = S_{x}
$$

计算了所有像素之后，得到的强度必须经过阈值处理，所有的像素都会对模板有一定的相应，但是只有非常大的相应才能评判未边缘。

另外一个例子是Kirsch算子，它有8个方向的矩阵，该算法会对每一个像素位置进行8次运算，算子在一个像素的相应为这8个掩模相应中的最大值。值为
$\pi/4*i$ ，其中$i$为具有最大相应的掩模编号。

#### 边缘模型：Marr-Hildreth边缘检测器
通过David Marr的研究，可以将一个边缘检测算法描述为：
- 1. 通过一个二维高斯函数对图像I进行卷积运算。（进行这一步的原因是自然场景一般不会出现衍射图案和其他波状效果，因此必须进行局部平均值计算，而符合生物视觉需求的最优平滑滤波器为高斯滤波）
- 2. 计算卷积图像的拉普拉斯算子，称为L。
- 3. 寻找边缘像素---在L中存在零交叉的像素。

##### 术语解释
过零点：数学性质，如果图像剧烈变化，进行一阶微分则会形成一个局部的极值，二阶微分则会形成一个过零点，并且在零点两边产生一个波峰和波谷。如图
<div align = center>
<img src="../img/过零点.png">
</div>
过零点的确认：以p点为中心的3x3矩阵，p点过零点意味着至少有两个相对的领域的像素不同，有四种要检测的情况：左右、上下、和两个对角.如果g(x,y)的值与一个阈值比较（一种通用的方法），那么不仅要求相对领域的符号不同，数值差的绝对值要超过这个阈值，这时p称为一个过零点像素。

二阶函数关心的是图像灰度的突变，而不是强调灰度缓慢变化的区域， 所以对边缘的检测能力更强。

拉普拉斯算子：是n维欧几里得空间中的一个二阶微分算子，定义为梯度的散度，二维中公式如下：
$$
\triangle f = \frac{\partial^{2}f}{\partial x^{2}} + \frac{\partial^{2}f}{\partial y^{2}}
$$

图像差分：把图像像素点减去其相邻像素点，这样做可以削弱图像相似部分，进而突出图像的变化部分，这也于我们的边缘检测任务相契合。

#### Canny Edge 边缘检测器
Canny定义了一组边缘检测器应该达到的目标，并且描述了一个能够达到这些目标的最优化方法。
- **错误率**:边缘检测器应该只对边缘有相应，而且应该找到所有的边缘像素，不应该错过任何的边缘像素。
- **局部性(Localization)**:边缘检测器找到的边缘像素距离实际边缘的距离应该越小越好。
- **响应**:如果在一处只存在一个边缘像素，那么边缘检测器不应该识别出多个边缘像素。

Canny假定阶梯型边缘会受到高斯白噪声的影响。边缘检测器被假定为一个卷积过滤器$f$，$f$应该平滑噪声并定位边缘。目标是找出一种过滤器能够在者三条准则上达到最优。

在一个维度上，过滤器$f$对一个边缘$G$的响应由以下卷积积分给出：
$$
H = \int_{-W}^{W}G(-x)f(x)dx
$$
这个过滤器在区间 $[-W,W]$ 之外为0。在数学上，上述三条准则可以描述为：
$$
SNR=\frac{A\left | \int_{-W}^{0}f(x)dx \right |}{n_{0}\sqrt{\int_{-W}^{W}f^{2}(x)dx}}
$$

$$
Localization=\frac{A\left | f(0) \right |}{n_{0}\sqrt{\int_{-W}^{W}f^{2}dx}}
$$

$$
x_{zc}=\pi (\frac {\int_{-\infty}^{+\infty}f^{2}(x)dx}{\int_{-\infty}^{+\infty}f^{2}(x)dx})^{\frac{1}{2}}
$$

其中 $SNR$ 的值为输出信噪比（错误率），这个值应该尽可能大：我们需要很大的信号以及很小的噪音。$Localization$ 值表示找到的边缘距离距离真实边距的距离的倒数，这个值应该尽可能大，也就是说距离应该尽可能小。$x_{zc}$ 的值为一个约束，表示$f$ 的零交叉之间距离的平均值，实际上表示边缘检测器 $f$ 在一个小的区域内不会对同一边缘有太多响应。

Canny尝试找出一个能够在服从多种响应约束的情况下最大化 $SNR$ 和 $Localization$ 的乘积的过滤器 $f$ 。尽管很难通过分析的方法得到结果，不过高斯函数的一阶导数是一个很好的近似。高斯函数如下：
$$
G(x) = e^{- \frac{x^2}{2\sigma^2}}
$$
对x求导的结果为：
$$
{G}'(x)=(-\frac{x}{\sigma^2})e^{-(\frac{x^2}{2\sigma^2})}
$$
二维维度上的高斯函数：
$$
G(x,y) = \sigma^2 e^{-\left ( \frac{x^2+y^2}{2\sigma^2} \right )}
$$

G可以在 $x$ 和 $y$ 方向求导，Canny的边缘检测最优化过滤器近似为 ${G}'$,因此利用 ${G}'$ 对输入图像进行卷积操作，即使在存在噪声的情况下，我们也可以得到一个增强边缘的图像E，这个图像被集成为边缘图像模型的一部分。

总结Canny算法的步骤如下：

（1）**高斯模糊**：其主要作用就是去噪，因为噪音也属于高频信号，会对边缘检测有一定的影响，使用高斯滤波器对图像进行卷积，该步骤将平滑图像，用来减少边缘检测器上明显的噪声影响。但是高斯模糊的半径需要仔细选取，太大的半径会对图像边缘造成影响。

（2）**计算梯度强度和方向**：图像的边缘可以指向任何方向，因此Canny算子使用四个梯度算子来检测边缘的方向，分别是水平、竖直和两个对角线方向的梯度，但是通常都不用四个梯度算子来分别计算四个方向。常用的边缘差分算子（如Rober，Prewitt，Sobel）计算水平和垂直方向的差分Gx和Gy。这样就可以如下计算梯度模和方向：
$$
G = \sqrt{G_{x}^2+G_{y}^2} \\
\theta = \arctan \left (\frac{G_y}{G_x}\right )
$$
其中 $G$ 为梯度强度，$\theta$为梯度方向

（3）**非极大抑制**：非极大抑制是一种抑制方法，其可以将返回的多个结果中选取最好的一个，并且抑制其他的结果，在边缘检测中，其作用就是细化边缘，只保留边缘最锐利的部分。

（4）**双阈值检测**：在施加非极大值抑制之后，剩余的像素可以更准确地表示图像中的实际边缘。然而，仍然存在由于噪声和颜色变化引起的一些边缘像素。为了解决这些杂散响应，必须用弱梯度值过滤边缘像素，并保留具有高梯度值的边缘像素，可以通过选择高低阈值来实现。如果边缘像素的梯度值高于高阈值，则将其标记为强边缘像素；如果边缘像素的梯度值小于高阈值并且大于低阈值，则将其标记为弱边缘像素；如果边缘像素的梯度值小于低阈值，则会被抑制。阈值的选择取决于给定输入图像的内容。

（5）**抑制孤立低阈值点**：被划分为强边缘的像素点已经被确定为边缘，因为它们是从图像中的真实边缘中提取出来的。然而，对于弱边缘像素，将会有一些争论，因为这些像素可以从真实边缘提取也可以是因噪声或颜色变化引起的。为了获得准确的结果，应该抑制由后者引起的弱边缘。通常，由真实边缘引起的弱边缘像素将连接到强边缘像素，而噪声响应未连接。为了跟踪边缘连接，通过查看弱边缘像素及其8个邻域像素，只要其中一个为强边缘像素，则该弱边缘点就可以保留为真实的边缘。

#### 参考
- [Canny边缘检测](https://www.cnblogs.com/techyan1990/p/7291771.html)
- [算子比较](https://www.sohu.com/a/247451442_468740)

#### Shen-Castan(ISEF)边缘检测器

Shen和Castan在边缘检测器的基本形式上与Canny意见一致：首先利用平滑核（smoothing kernel）进行卷积运算，然后再搜索边缘像素。然而，他们通过分析得到一个不同的函数进行优化：即提出了最小化优化：
$$
G^2_N=\frac{4\int_{0}^{\infty}f^2(x)dx\cdot \int_{0}^{\infty}{f}'^2(x)dx}{f^4(0)}
$$

也就是说最小化 $C_{N}$ 的函数适用于边缘检测器的最优平滑滤波器。他们得到的最优滤波器函数为无穷对称指数滤波器(infinite symmetric exponential filter, ISEF):
$$
f(x) = \frac{p}{2}e^{-p \left | x \right |}
$$
 这个滤波器相比于Canny的可以给出更好的信噪比.
